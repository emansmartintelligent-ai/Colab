<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YNS Universal Transcoder</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #050505; color: #00ff41; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: #111; padding: 25px; border-radius: 12px; border: 1px solid #00ff41; }
        .controls { background: #1a1a1a; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; margin-bottom: 20px; border: 1px solid #333; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        canvas, video { width: 100%; border: 1px solid #00ff41; border-radius: 4px; background: #000; image-rendering: pixelated; transform: scaleX(-1); }
        .data-panel { margin-top: 15px; background: #000; padding: 10px; font-family: 'Courier New', monospace; height: 100px; font-size: 11px; overflow: hidden; border: 1px solid #00ff41; }
        .status-gap { color: #ff3b3b; font-weight: bold; }
        button { background: #00ff41; color: #000; border: none; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        select, label { color: #00ff41; display: block; margin-bottom: 5px; }
        select { background: #222; border: 1px solid #00ff41; padding: 8px; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <h2>YNS Universal Base Transcoder (Mirrored Feed)</h2>
    
    <div class="controls">
        <div>
            <button id="startBtn" style="width:100%">Initialize YNS Sensor</button>
        </div>
        <div>
            <label>Select Base:</label>
            <select id="baseSelect">
                <option value="adaptive">Adaptive (Auto-Sense)</option>
                <option value="2">Base-2</option>
                <option value="3">Base-3</option>
                <option value="4">Base-4</option>
                <option value="5">Base-5</option>
                <option value="7">Base-7</option>
                <option value="12">Base-12</option>
                <option value="16">Base-16</option>
                <option value="20" selected>Base-20 (Standard)</option>
                <option value="31">Base-31</option>
                <option value="40">Base-40</option>
                <option value="60">Base-60</option>
                <option value="70">Base-70</option>
                <option value="91">Base-91</option>
                <option value="120">Base-120</option>
            </select>
        </div>
        <div>
            <button onclick="downloadFrame()" style="background:#007bff; color:white; width:100%">Capture Frame</button>
        </div>
    </div>

    <div class="grid">
        <video id="video" autoplay muted playsinline style="display:none;"></video>
        <div>
            <h4 style="color:#fff; text-align:center;">Mirrored Input</h4>
            <canvas id="origCanvas"></canvas>
        </div>
        <div>
            <h4 style="color:#fff; text-align:center;">YNS Logic Output</h4>
            <canvas id="ynsCanvas"></canvas>
        </div>
    </div>

    <div class="data-panel" id="bitstream">Bitstream: Waiting for Initialization...</div>
</div>

<script>
const video = document.getElementById('video');
const baseSelect = document.getElementById('baseSelect');
const bitstream = document.getElementById('bitstream');
const startBtn = document.getElementById('startBtn');
const origCanvas = document.getElementById('origCanvas');
const ynsCanvas = document.getElementById('ynsCanvas');
const ctxOrig = origCanvas.getContext('2d', {alpha: false});
const ctxYns = ynsCanvas.getContext('2d', {alpha: false});

let isStreaming = false;

startBtn.addEventListener('click', async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.onloadedmetadata = () => { video.play(); isStreaming = true; processFrame(); };
    } catch (err) { console.error("Permission Denied", err); }
});

function getBestYNS(val, mode) {
    const bases = mode === 'adaptive' ? [2, 12, 20, 40, 60, 120] : [parseInt(mode)];
    for (let b of bases) {
        let landmark = Math.round(val / b) * b;
        let offset = val - landmark;
        if (Math.abs(offset) <= 5) return { landmark, offset, base: b };
    }
    return null;
}

function processFrame() {
    if (!isStreaming) return;
    const mode = baseSelect.value;
    const w = origCanvas.width = ynsCanvas.width = 320; 
    const h = origCanvas.height = ynsCanvas.height = 240;

    ctxOrig.drawImage(video, 0, 0, w, h);
    const frame = ctxOrig.getImageData(0, 0, w, h);
    const outFrame = ctxYns.createImageData(w, h);
    let streamOut = "";

    for (let i = 0; i < frame.data.length; i += 4) {
        let gray = (frame.data[i] + frame.data[i+1] + frame.data[i+2]) / 3;
        let res = getBestYNS(gray, mode);

        if (res) {
            outFrame.data[i] = outFrame.data[i+1] = outFrame.data[i+2] = gray;
            outFrame.data[i+3] = 255;
            if (i % 4000 === 0) {
                let score = Math.min(Math.round(res.landmark/res.base), 15).toString(2).padStart(4,'0');
                streamOut += `${score}${res.offset >= 0 ? "0" : "1"}${Math.abs(res.offset).toString(2).padStart(3,'0')} `;
            }
        } else {
            outFrame.data[i] = 255; outFrame.data[i+1] = 0; outFrame.data[i+2] = 0; outFrame.data[i+3] = 255;
            if (i % 4000 === 0) streamOut += "<span class='status-gap'>[GAP]</span> ";
        }
    }
    ctxYns.putImageData(outFrame, 0, 0);
    bitstream.innerHTML = streamOut;
    requestAnimationFrame(processFrame);
}

function downloadFrame() {
    const link = document.createElement('a');
    link.download = `YNS_Universal_Base${baseSelect.value}.png`;
    link.href = ynsCanvas.toDataURL();
    link.click();
}
</script>
</body>
</html>
