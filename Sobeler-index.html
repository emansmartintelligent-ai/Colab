<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sobel PWA</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #1a1a1a; color: white; margin: 0; padding: 20px; }
        canvas, video { max-width: 100%; border-radius: 8px; background: #000; margin-top: 10px; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; }
        button, label { background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background: #2980b9; }
        input[type="file"] { display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <h1>Sobel Filter PWA</h1>

    <div class="controls">
        <label for="upload">Upload Image</label>
        <input type="file" id="upload" accept="image/*">
        
        <button id="cameraToggle">Start Live Camera</button>
        <button id="downloadBtn">Download Result</button>
    </div>

    <video id="video" autoplay playsinline class="hidden"></video>
    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const video = document.getElementById('video');
        const upload = document.getElementById('upload');
        const downloadBtn = document.getElementById('downloadBtn');
        const cameraToggle = document.getElementById('cameraToggle');

        let isCameraRunning = false;
        let animationId;

        // Sobel Algorithm
        function applySobel(width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            const output = ctx.createImageData(width, height);
            const outData = output.data;

            const kernelX = [[-1, 0, 1], [-2, 0, 2], [-1, 0, 1]];
            const kernelY = [[-1, -2, -1], [0, 0, 0], [1, 2, 1]];

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    let pixelX = 0;
                    let pixelY = 0;

                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const idx = ((y + ky) * width + (x + kx)) * 4;
                            const avg = (data[idx] + data[idx+1] + data[idx+2]) / 3;
                            pixelX += avg * kernelX[ky+1][kx+1];
                            pixelY += avg * kernelY[ky+1][kx+1];
                        }
                    }

                    const magnitude = Math.sqrt(pixelX * pixelX + pixelY * pixelY);
                    const outIdx = (y * width + x) * 4;
                    outData[outIdx] = outData[outIdx+1] = outData[outIdx+2] = magnitude;
                    outData[outIdx+3] = 255;
                }
            }
            ctx.putImageData(output, 0, 0);
        }

        // Image Upload Handling
        upload.addEventListener('change', (e) => {
            stopCamera();
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    applySobel(img.width, img.height);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        // Camera Handling
        cameraToggle.addEventListener('click', async () => {
            if (isCameraRunning) {
                stopCamera();
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                    video.srcObject = stream;
                    isCameraRunning = true;
                    cameraToggle.innerText = "Stop Camera";
                    processVideo();
                } catch (err) {
                    alert("Camera access denied");
                }
            }
        });

        function processVideo() {
            if (!isCameraRunning) return;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            applySobel(canvas.width, canvas.height);
            animationId = requestAnimationFrame(processVideo);
        }

        function stopCamera() {
            isCameraRunning = false;
            cancelAnimationFrame(animationId);
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            cameraToggle.innerText = "Start Live Camera";
        }

        // Download
        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'sobel-filter.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
