<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SobelVision - Edge Detection PWA</title>
    
    <meta name="theme-color" content="#14b8a6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SobelVision">
    
    <link rel="manifest" href="Sobeler.webmanifest">
    
    <link rel="icon" type="image/png" href="https://olubowale.lovable.app/pwa-192x192.png">
    <link rel="apple-touch-icon" href="https://olubowale.lovable.app/pwa-192x192.png">

    <style>
        :root { 
            --primary: #14b8a6; 
            --background: #10141a; 
            --card: #1a1f26; 
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--background); 
            color: white; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px;
        }
        .app-container { max-width: 480px; width: 100%; text-align: center; }
        
        h1 { font-size: 1.5rem; margin-bottom: 5px; }
        .accent { color: var(--primary); }
        
        canvas, video { 
            width: 100%; 
            border-radius: 12px; 
            background: #000; 
            margin-top: 15px; 
            border: 1px solid rgba(20, 184, 166, 0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .controls { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-top: 20px; 
        }

        button, .upload-label { 
            background: var(--card); 
            border: 1px solid rgba(20, 184, 166, 0.4); 
            color: white; 
            padding: 12px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover, .upload-label:hover { 
            border-color: var(--primary);
            background: rgba(20, 184, 166, 0.1);
        }

        .primary-btn { 
            background: var(--primary); 
            color: #10141a; 
            font-weight: bold; 
            border: none;
        }

        /* The Install Button - Amber color to stand out */
        #installBtn {
            grid-column: span 2;
            background: #fbbf24; 
            color: black;
            font-weight: bold;
            display: none; /* Hidden by default until browser says it's ready */
        }

        .full-width { grid-column: span 2; }
        input[type="file"] { display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="app-container">
        <h1>Sobel<span class="accent">Vision</span></h1>
        <p style="color: #94a3b8; font-size: 0.8rem;">Image Edge Detection PWA</p>

        <video id="video" autoplay playsinline class="hidden"></video>
        <canvas id="canvas"></canvas>

        <div class="controls">
            <button id="installBtn">âœ¨ Install App to Home Screen</button>

            <label for="upload" class="upload-label full-width">
                Upload Image
            </label>
            <input type="file" id="upload" accept="image/*">

            <button id="frontCamBtn" class="primary-btn">Live Front Camera</button>
            <button id="downloadBtn">Download Result</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const video = document.getElementById('video');
        const upload = document.getElementById('upload');
        const downloadBtn = document.getElementById('downloadBtn');
        const frontCamBtn = document.getElementById('frontCamBtn');
        const installBtn = document.getElementById('installBtn');

        let isStreaming = false;
        let deferredPrompt;

        // --- 1. PWA INSTALLATION LOGIC ---
        // This listens for the browser to say "I'm ready to install!"
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('Install prompt fired');
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'flex'; // Show the button
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBtn.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // --- 2. SOBEL FILTER LOGIC ---
        function applySobel() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const w = canvas.width;
            const h = canvas.height;
            const output = ctx.createImageData(w, h);
            const outData = output.data;

            for (let y = 1; y < h - 1; y++) {
                for (let x = 1; x < w - 1; x++) {
                    const i = (y * w + x) * 4;
                    const pixelLeft = (data[i - 4] + data[i - 3] + data[i - 2]) / 3;
                    const pixelRight = (data[i + 4] + data[i + 5] + data[i + 6]) / 3;
                    const pixelUp = (data[i - w * 4] + data[i - w * 4 + 1] + data[i - w * 4 + 2]) / 3;
                    const pixelDown = (data[i + w * 4] + data[i + w * 4 + 1] + data[i + w * 4 + 2]) / 3;

                    const mag = Math.abs(pixelRight - pixelLeft) + Math.abs(pixelDown - pixelUp);

                    outData[i] = outData[i + 1] = outData[i + 2] = mag;
                    outData[i + 3] = 255;
                }
            }
            ctx.putImageData(output, 0, 0);
        }

        // --- 3. CAMERA LOGIC ---
        frontCamBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" } 
                });
                video.srcObject = stream;
                isStreaming = true;
                requestAnimationFrame(renderVideo);
            } catch (err) {
                alert("Camera Access Required for Live Feed.");
            }
        });

        function renderVideo() {
            if (!isStreaming) return;
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                applySobel();
            }
            requestAnimationFrame(renderVideo);
        }

        // --- 4. UPLOAD LOGIC ---
        upload.addEventListener('change', (e) => {
            isStreaming = false; 
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    applySobel();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        // --- 5. DOWNLOAD LOGIC ---
        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'sobel-vision-capture.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        // --- 6. CRITICAL: SERVICE WORKER REGISTRATION ---
        // This is what makes it a PWA. It MUST be inside script tags.
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW Registered!', reg))
                    .catch(err => console.log('SW Failed', err));
            });
        }
    </script>
</body>
</html>

